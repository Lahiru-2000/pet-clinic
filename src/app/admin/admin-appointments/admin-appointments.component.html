<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-calendar-check me-2"></i>
      Appointment Management
    </h2>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary" (click)="refreshAppointments()">
        <i class="bi bi-arrow-clockwise me-2"></i>
        Refresh
      </button>
      <button class="btn btn-outline-success" (click)="exportAppointments()">
        <i class="bi bi-download me-2"></i>
        Export
      </button>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="bi bi-plus-circle me-2"></i>
        Add Appointment
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-funnel me-2"></i>
        Filters & Search
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Search -->
        <div class="col-md-3">
          <label for="searchTerm" class="form-label">Search</label>
          <input 
            type="text" 
            id="searchTerm"
            class="form-control" 
            [(ngModel)]="searchTerm"
            (input)="applyFilters()"
            placeholder="Search by name, pet, email...">
        </div>

        <!-- Date From -->
        <div class="col-md-2">
          <label for="dateFrom" class="form-label">Date From</label>
          <input 
            type="date" 
            id="dateFrom"
            class="form-control" 
            [(ngModel)]="dateFrom"
            (change)="applyFilters()">
        </div>

        <!-- Date To -->
        <div class="col-md-2">
          <label for="dateTo" class="form-label">Date To</label>
          <input 
            type="date" 
            id="dateTo"
            class="form-control" 
            [(ngModel)]="dateTo"
            (change)="applyFilters()">
        </div>

        <!-- Status Filter -->
        <div class="col-md-2">
          <label for="statusFilter" class="form-label">Status</label>
          <select 
            id="statusFilter"
            class="form-select" 
            [(ngModel)]="selectedStatus"
            (change)="applyFilters()">
            <option value="">All Statuses</option>
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ status | titlecase }}
            </option>
          </select>
        </div>

        <!-- Doctor Filter -->
        <div class="col-md-2">
          <label for="doctorFilter" class="form-label">Doctor</label>
          <select 
            id="doctorFilter"
            class="form-select" 
            [(ngModel)]="selectedDoctor"
            (change)="applyFilters()">
            <option value="">All Doctors</option>
            <option *ngFor="let doctor of doctors" [value]="doctor.name">
              {{ doctor.name }}
            </option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-outline-secondary" (click)="clearFilters()">
            <i class="bi bi-x-circle me-1"></i>
            Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="text-muted">
      Showing {{ paginatedAppointments.length }} of {{ totalItems }} appointments
    </div>
    <div class="d-flex align-items-center gap-2">
      <label for="itemsPerPage" class="form-label mb-0">Items per page:</label>
      <select 
        id="itemsPerPage"
        class="form-select form-select-sm" 
        [(ngModel)]="itemsPerPage"
        (change)="applyFilters()"
        style="width: auto;">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading appointments...</p>
  </div>

  <!-- Appointments Table -->
  <div class="card" *ngIf="!isLoading">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Date & Time</th>
              <th>Pet Details</th>
              <th>Owner Details</th>
              <th>Doctor</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let appointment of paginatedAppointments">
              <td>
                <div class="fw-bold">{{ formatDate(appointment.date) }}</div>
                <small class="text-muted">{{ formatTime(appointment.time) }}</small>
              </td>
              <td>
                <div class="fw-bold">
                  <i class="bi bi-heart text-danger me-1"></i>
                  {{ appointment.petname }}
                </div>
                <small class="text-muted" *ngIf="appointment.petBreed">
                  {{ appointment.petBreed }}
                  <span *ngIf="appointment.petAge"> - {{ appointment.petAge }}</span>
                </small>
                <div class="mt-1" *ngIf="appointment.reasonForVisit">
                  <small class="badge bg-light text-dark">{{ appointment.reasonForVisit }}</small>
                </div>
              </td>
              <td>
                <div class="fw-bold">{{ appointment.name }}</div>
                <small class="text-muted d-block">{{ appointment.email }}</small>
                <small class="text-muted" *ngIf="appointment.contactNumber">
                  <i class="bi bi-telephone me-1"></i>{{ appointment.contactNumber }}
                </small>
              </td>
              <td>
                <div class="fw-bold">{{ appointment.docname }}</div>
                <small class="text-muted" *ngIf="appointment.appointmentType">
                  {{ appointment.appointmentType }}
                </small>
              </td>
              <td>
                <span [ngClass]="getStatusBadgeClass(appointment.status)">
                  {{ appointment.status | titlecase }}
                </span>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                          type="button" 
                          data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <!-- Status Updates -->
                    <li *ngIf="appointment.status !== 'confirmed'">
                      <a class="dropdown-item" 
                         (click)="updateAppointmentStatus(appointment, 'confirmed')">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        Confirm
                      </a>
                    </li>
                    <li *ngIf="appointment.status !== 'completed'">
                      <a class="dropdown-item" 
                         (click)="updateAppointmentStatus(appointment, 'completed')">
                        <i class="bi bi-check2-all text-primary me-2"></i>
                        Mark Complete
                      </a>
                    </li>
                    <li *ngIf="appointment.status !== 'cancelled'">
                      <a class="dropdown-item" 
                         (click)="updateAppointmentStatus(appointment, 'cancelled')">
                        <i class="bi bi-x-circle text-danger me-2"></i>
                        Cancel
                      </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- CRUD Operations -->
                    <li>
                      <a class="dropdown-item" (click)="openEditModal(appointment)">
                        <i class="bi bi-pencil text-warning me-2"></i>
                        Edit
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" (click)="openDeleteModal(appointment)">
                        <i class="bi bi-trash me-2"></i>
                        Delete
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            <tr *ngIf="paginatedAppointments.length === 0">
              <td colspan="6" class="text-center py-4 text-muted">
                <i class="bi bi-calendar-x me-2"></i>
                No appointments found matching your criteria.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav aria-label="Appointments pagination" *ngIf="totalPages > 1">
    <ul class="pagination justify-content-center mt-4">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="changePage(currentPage - 1)">Previous</a>
      </li>
      <li class="page-item" 
          *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="currentPage === i + 1">
        <a class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="changePage(currentPage + 1)">Next</a>
      </li>
    </ul>
  </nav>
</div>

<!-- Create Appointment Modal -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-2"></i>
          Add New Appointment
        </h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3">
            <!-- Date & Time -->
            <div class="col-md-6">
              <label for="createDate" class="form-label">Date *</label>
              <input type="date" id="createDate" class="form-control" [(ngModel)]="appointmentForm.date" name="date" required>
            </div>
            <div class="col-md-6">
              <label for="createTime" class="form-label">Time *</label>
              <input type="time" id="createTime" class="form-control" [(ngModel)]="appointmentForm.time" name="time" required>
            </div>

            <!-- Pet Details -->
            <div class="col-md-6">
              <label for="createPetName" class="form-label">Pet Name *</label>
              <input type="text" id="createPetName" class="form-control" [(ngModel)]="appointmentForm.petname" name="petname" required>
            </div>
            <div class="col-md-3">
              <label for="createPetAge" class="form-label">Pet Age</label>
              <input type="text" id="createPetAge" class="form-control" [(ngModel)]="appointmentForm.petAge" name="petAge" placeholder="e.g., 2 years">
            </div>
            <div class="col-md-3">
              <label for="createPetBreed" class="form-label">Pet Breed</label>
              <input type="text" id="createPetBreed" class="form-control" [(ngModel)]="appointmentForm.petBreed" name="petBreed">
            </div>

            <!-- Owner Details -->
            <div class="col-md-6">
              <label for="createOwnerName" class="form-label">Owner Name *</label>
              <input type="text" id="createOwnerName" class="form-control" [(ngModel)]="appointmentForm.name" name="name" required>
            </div>
            <div class="col-md-6">
              <label for="createOwnerEmail" class="form-label">Owner Email *</label>
              <input type="email" id="createOwnerEmail" class="form-control" [(ngModel)]="appointmentForm.email" name="email" required>
            </div>
            <div class="col-md-6">
              <label for="createContactNumber" class="form-label">Contact Number</label>
              <input type="tel" id="createContactNumber" class="form-control" [(ngModel)]="appointmentForm.contactNumber" name="contactNumber">
            </div>

            <!-- Doctor & Type -->
            <div class="col-md-6">
              <label for="createDoctor" class="form-label">Doctor *</label>
              <select id="createDoctor" class="form-select" [(ngModel)]="appointmentForm.docname" name="docname" required>
                <option value="">Select Doctor</option>
                <option *ngFor="let doctor of doctors" [value]="doctor.name">
                  {{ doctor.name }} - {{ doctor.specialization }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="createAppointmentType" class="form-label">Appointment Type</label>
              <select id="createAppointmentType" class="form-select" [(ngModel)]="appointmentForm.appointmentType" name="appointmentType">
                <option value="">Select Type</option>
                <option value="Checkup">General Checkup</option>
                <option value="Vaccination">Vaccination</option>
                <option value="Surgery">Surgery</option>
                <option value="Emergency">Emergency</option>
                <option value="Dental">Dental Care</option>
                <option value="Grooming">Grooming</option>
              </select>
            </div>

            <!-- Reason & Notes -->
            <div class="col-12">
              <label for="createReason" class="form-label">Reason for Visit</label>
              <input type="text" id="createReason" class="form-control" [(ngModel)]="appointmentForm.reasonForVisit" name="reasonForVisit" placeholder="Brief description of the visit purpose">
            </div>
            <div class="col-12">
              <label for="createNotes" class="form-label">Additional Notes</label>
              <textarea id="createNotes" class="form-control" rows="3" [(ngModel)]="appointmentForm.notes" name="notes" placeholder="Any additional information..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="createAppointment()" [disabled]="isCreating">
          <span *ngIf="isCreating" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!isCreating" class="bi bi-plus-circle me-2"></i>
          {{ isCreating ? 'Creating...' : 'Create Appointment' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Appointment Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil me-2"></i>
          Edit Appointment
        </h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3">
            <!-- Date & Time -->
            <div class="col-md-6">
              <label for="editDate" class="form-label">Date</label>
              <input type="date" id="editDate" class="form-control" [(ngModel)]="editForm.date" name="date">
            </div>
            <div class="col-md-6">
              <label for="editTime" class="form-label">Time</label>
              <input type="time" id="editTime" class="form-control" [(ngModel)]="editForm.time" name="time">
            </div>

            <!-- Pet Details -->
            <div class="col-md-6">
              <label for="editPetName" class="form-label">Pet Name</label>
              <input type="text" id="editPetName" class="form-control" [(ngModel)]="editForm.petname" name="petname">
            </div>
            <div class="col-md-3">
              <label for="editPetAge" class="form-label">Pet Age</label>
              <input type="text" id="editPetAge" class="form-control" [(ngModel)]="editForm.petAge" name="petAge">
            </div>
            <div class="col-md-3">
              <label for="editPetBreed" class="form-label">Pet Breed</label>
              <input type="text" id="editPetBreed" class="form-control" [(ngModel)]="editForm.petBreed" name="petBreed">
            </div>

            <!-- Owner Details -->
            <div class="col-md-6">
              <label for="editOwnerName" class="form-label">Owner Name</label>
              <input type="text" id="editOwnerName" class="form-control" [(ngModel)]="editForm.name" name="name">
            </div>
            <div class="col-md-6">
              <label for="editOwnerEmail" class="form-label">Owner Email</label>
              <input type="email" id="editOwnerEmail" class="form-control" [(ngModel)]="editForm.email" name="email">
            </div>
            <div class="col-md-6">
              <label for="editContactNumber" class="form-label">Contact Number</label>
              <input type="tel" id="editContactNumber" class="form-control" [(ngModel)]="editForm.contactNumber" name="contactNumber">
            </div>

            <!-- Doctor & Status -->
            <div class="col-md-6">
              <label for="editDoctor" class="form-label">Doctor</label>
              <select id="editDoctor" class="form-select" [(ngModel)]="editForm.docname" name="docname">
                <option value="">Select Doctor</option>
                <option *ngFor="let doctor of doctors" [value]="doctor.name">
                  {{ doctor.name }} - {{ doctor.specialization }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editStatus" class="form-label">Status</label>
              <select id="editStatus" class="form-select" [(ngModel)]="editForm.status" name="status">
                <option *ngFor="let status of statusOptions" [value]="status">
                  {{ status | titlecase }}
                </option>
              </select>
            </div>

            <!-- Type & Reason -->
            <div class="col-md-6">
              <label for="editAppointmentType" class="form-label">Appointment Type</label>
              <select id="editAppointmentType" class="form-select" [(ngModel)]="editForm.appointmentType" name="appointmentType">
                <option value="">Select Type</option>
                <option value="Checkup">General Checkup</option>
                <option value="Vaccination">Vaccination</option>
                <option value="Surgery">Surgery</option>
                <option value="Emergency">Emergency</option>
                <option value="Dental">Dental Care</option>
                <option value="Grooming">Grooming</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editReason" class="form-label">Reason for Visit</label>
              <input type="text" id="editReason" class="form-control" [(ngModel)]="editForm.reasonForVisit" name="reasonForVisit">
            </div>

            <!-- Notes -->
            <div class="col-12">
              <label for="editNotes" class="form-label">Additional Notes</label>
              <textarea id="editNotes" class="form-control" rows="3" [(ngModel)]="editForm.notes" name="notes"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateAppointment()" [disabled]="isUpdating">
          <span *ngIf="isUpdating" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!isUpdating" class="bi bi-check-circle me-2"></i>
          {{ isUpdating ? 'Updating...' : 'Update Appointment' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle text-danger me-2"></i>
          Confirm Delete
        </h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this appointment?</p>
        <div class="alert alert-warning" *ngIf="currentAppointment">
          <strong>Appointment Details:</strong><br>
          <strong>Pet:</strong> {{ currentAppointment.petname }}<br>
          <strong>Owner:</strong> {{ currentAppointment.name }}<br>
          <strong>Date:</strong> {{ formatDate(currentAppointment.date) }} at {{ formatTime(currentAppointment.time) }}<br>
          <strong>Doctor:</strong> {{ currentAppointment.docname }}
        </div>
        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="deleteAppointment()">
          <i class="bi bi-trash me-2"></i>
          Delete Appointment
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade show" *ngIf="showCreateModal || showEditModal || showDeleteModal" (click)="closeCreateModal(); closeEditModal(); closeDeleteModal()"></div> 